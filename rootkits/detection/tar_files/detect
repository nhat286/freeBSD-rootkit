#!/bin/sh

# Dispatcher script, for individual stages of detection checkout the stage?.sh files
PERSIST="/usr/local/etc/rc.d/STARTUP.sh"
LOG="/tmp/progress.log"

### STAGE 0 ###
    ps ax | grep -v grep | grep STAGE1 > /dev/null
    # If stage1 daemon is not present, enter here
    if [ $? -eq 1 ]
    then
        echo "Executing Stage 0" >> $LOG
        sh ./stage0.sh
        RESULT=$?

        # set stage1 daemon to signal stage 0 complete [REBOOT persistence]
        cmd="daemon -f -t STAGE1 -r sleep 1000"
        echo "$cmd" >> $PERSIST
        eval "$cmd"

        # return the result of this stage (0 or 1)
        exit $RESULT
    fi

### STAGE 1 ###
    ps ax | grep -v grep | grep STAGE2 > /dev/null
    # If stage2 daemon is not present, enter here
    if [ $? -eq 1 ]
    then
        echo "Executing Stage 1" >> $LOG
        sh ./stage0.sh
        RESULT=$?

        # set stage1 daemon to signal stage 0 complete [REBOOT persistence]
        cmd="daemon -f -t STAGE1 -r sleep 1000"
        echo "$cmd" >> $PERSIST
        eval "$cmd"

        # return the result of this stage (0 or 1)
        exit $RESULT
    fi

# >>> VM is rebooted after this stage <<< #

### STAGE 2 ###
    # if stage3 daemon is not present, enter here

    # set stage3 daemon to signal stage 2 complete [REBOOT persistence] 

### STAGE 3 ###
    # if stage4 daemon is not present, enter here

    # set stage4 daemon to signal stage 3 complete [REBOOT persistence] 

### STAGE 4 ###
    
    # kill all daemons after complete 
